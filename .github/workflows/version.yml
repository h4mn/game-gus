name: Auto Version Update

on:
  push:
    branches: [ main, master ]
    paths:
      - 'src/**/*.c'
      - 'src/**/*.h'
  pull_request:
    branches: [ main, master ]
    paths:
      - 'src/**/*.c'
      - 'src/**/*.h'

jobs:
  version-update:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Setup Git
      run: |
        git config --global user.name "Game Gus Bot"
        git config --global user.email "gamegus@users.noreply.github.com"

    - name: Calculate version
      id: version
      run: |
        # Get current version from README
        CURRENT_VERSION=$(grep "VersÃ£o:" README.md | grep -o '[0-9]\+\.[0-9]\+\.[0-9]\+' | head -1)

        if [ -z "$CURRENT_VERSION" ]; then
          CURRENT_VERSION="0.0.1"
        fi

        # Parse version
        MAJOR=$(echo $CURRENT_VERSION | cut -d. -f1)
        MINOR=$(echo $CURRENT_VERSION | cut -d. -f2)
        PATCH=$(echo $CURRENT_VERSION | cut -d. -f3)

        # Get commit count for patch version
        COMMITS=$(git rev-list --count HEAD)
        NEW_PATCH=$((COMMITS % 100))

        NEW_VERSION="$MAJOR.$MINOR.$NEW_PATCH"

        echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
        echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
        echo "version_changed=$([ "$CURRENT_VERSION" != "$NEW_VERSION" ] && echo "true" || echo "false")" >> $GITHUB_OUTPUT

        echo "Current version: $CURRENT_VERSION"
        echo "New version: $NEW_VERSION"
        echo "Version changed: $([ "$CURRENT_VERSION" != "$NEW_VERSION" ] && echo "yes" || echo "no")"

    - name: Update version in README
      if: steps.version.outputs.version_changed == 'true'
      run: |
        # Update version in README.md
        sed -i "s/VersÃ£o: [0-9]\+\.[0-9]\+\.[0-9]\+/VersÃ£o: ${{ steps.version.outputs.new_version }}/g" README.md

        # Update version in game source if it exists
        if [ -f "src/game-gus.c" ]; then
          # Look for version comment or define
          if grep -q "// VersÃ£o:" src/game-gus.c; then
            sed -i "s/\/\/ VersÃ£o: [0-9]\+\.[0-9]\+\.[0-9]\+/\/\/ VersÃ£o: ${{ steps.version.outputs.new_version }}/g" src/game-gus.c
          elif grep -q "#define VERSION" src/game-gus.c; then
            sed -i "s/#define VERSION \"[0-9]\+\.[0-9]\+\.[0-9]\+\"/#define VERSION \"${{ steps.version.outputs.new_version }}\"/g" src/game-gus.c
          fi
        fi

    - name: Commit version update
      if: steps.version.outputs.version_changed == 'true'
      run: |
        git add README.md
        [ -f "src/game-gus.c" ] && git add src/game-gus.c || true

        # Check if there are actually changes to commit
        if ! git diff --staged --quiet; then
          git commit -m "chore: Update version to ${{ steps.version.outputs.new_version }} - ðŸ”– Auto-version update - ðŸ“ˆ ${{ steps.version.outputs.current_version }} â†’ ${{ steps.version.outputs.new_version }} - ðŸ¤– Generated by GitHub Actions"
        else
          echo "No version changes to commit"
        fi

    - name: Push changes
      if: steps.version.outputs.version_changed == 'true'
      run: |
        # Only push if we actually made a commit
        if ! git diff --staged --quiet; then
          git push
        else
          echo "No changes to push"
        fi

    - name: Create release tag
      if: steps.version.outputs.version_changed == 'true' && github.ref == 'refs/heads/main'
      run: |
        git tag -a "v${{ steps.version.outputs.new_version }}" -m "Release v${{ steps.version.outputs.new_version }} - Game Gus v${{ steps.version.outputs.new_version }} - ðŸŽ® Roguelike Terminal - ðŸ“¦ Auto-generated release - ðŸš€ Ready for deployment"
        git push origin "v${{ steps.version.outputs.new_version }}"

    - name: Create GitHub Release
      if: steps.version.outputs.version_changed == 'true' && github.ref == 'refs/heads/main'
      uses: softprops/action-gh-release@v2
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: "v${{ steps.version.outputs.new_version }}"
        release_name: "Game Gus v${{ steps.version.outputs.new_version }}"
        body: |
          ## ðŸŽ® Game Gus v${{ steps.version.outputs.new_version }}

          Roguelike terminal desenvolvido em C ANSI.

          ### ðŸš€ Novidades
          - VersÃ£o atualizada automaticamente
          - CompilaÃ§Ã£o otimizada
          - Melhorias de interface

          ### ðŸ“¥ Como usar
          ```bash
          # Compilar
          gcc game-gus.c -o game.exe

          # Executar
          ./game.exe
          ```

          ### ðŸ‘¥ CrÃ©ditos
          - Gustavo Secco
          - Gustavo Silva
          - Luiz Saia
          - VinÃ­cius Heleno
          - Hadston Nunes
          - Sky (OtimizaÃ§Ãµes)
        draft: false
        prerelease: false